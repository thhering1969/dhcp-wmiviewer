// MainForm.Leases.Handlers.cs

using System;
using System.Data;
using System.Net;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace DhcpWmiViewer
{
    public partial class MainForm : Form
    {
        /// <summary>
        /// Wird aufgerufen, wenn der Benutzer "Change reservation IP..." im Leases-Contextmenu auswählt.
        /// Implementiert: Prefetch von Description (falls vorhanden), öffnet ChangeReservationDialog,
        /// und führt ChangeReservationIpAsync oder UpdateReservationPropertiesAsync aus.
        /// </summary>
        private async Task OnChangeReservationFromLeaseRowAsync()
        {
            try
            {
                if (dgvLeases == null || dgvLeases.SelectedRows.Count == 0)
                {
                    MessageBox.Show(this, "Bitte zuerst eine Lease-Zeile auswählen.", "Keine Auswahl", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }

                var leaseRow = dgvLeases.SelectedRows[0];
                var oldIp = leaseRow.Cells["IPAddress"]?.Value?.ToString() ?? string.Empty;
                var clientId = leaseRow.Cells["ClientId"]?.Value?.ToString() ?? string.Empty;
                var hostName = leaseRow.Cells["HostName"]?.Value?.ToString() ?? string.Empty;

                if (string.IsNullOrWhiteSpace(oldIp))
                {
                    MessageBox.Show(this, "Die ausgewählte Zeile enthält keine IP-Adresse.", "Fehler", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                // Scope ermitteln
                var scopeId = TryGetScopeIdFromSelection();
                if (string.IsNullOrWhiteSpace(scopeId))
                {
                    MessageBox.Show(this, "Bitte zuerst einen Scope oben auswählen.", "Fehler", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    return;
                }

                string startRange = string.Empty, endRange = string.Empty, subnetMask = string.Empty;
                try
                {
                    if (dgv != null && dgv.SelectedRows.Count > 0)
                    {
                        var srow = dgv.SelectedRows[0];
                        startRange = srow.Cells["StartRange"]?.Value?.ToString() ?? string.Empty;
                        endRange = srow.Cells["EndRange"]?.Value?.ToString() ?? string.Empty;
                        subnetMask = srow.Cells["SubnetMask"]?.Value?.ToString() ?? string.Empty;
                    }
                }
                catch { /* ignore */ }

                var server = GetServerNameOrDefault();

                // Prefetch description from reservations (if any) - best-effort
                string prefetchedDescription = string.Empty;
                try
                {
                    var resTable = await DhcpManager.QueryReservationsAsync(server, scopeId, s => GetCredentialsForServer(s)!);
                    if (resTable != null)
                    {
                        foreach (DataRow dr in resTable.Rows)
                        {
                            var ipVal = dr["IPAddress"]?.ToString() ?? string.Empty;
                            if (string.Equals(ipVal, oldIp, StringComparison.OrdinalIgnoreCase))
                            {
                                prefetchedDescription = dr["Description"]?.ToString() ?? string.Empty;
                                break;
                            }
                        }
                    }
                }
                catch
                {
                    // ignore - best-effort
                }

                using var dlg = new ChangeReservationDialog(oldIp, hostName, prefetchedDescription, startRange, endRange, subnetMask);

                if (dlg.ShowDialog(this) != DialogResult.OK) return;

                var newIp = dlg.NewIp?.Trim() ?? string.Empty;
                var newDescription = dlg.NewDescription?.Trim() ?? string.Empty;
                var newName = dlg.NewName ?? hostName;

                if (dlg.IpChanged)
                {
                    if (!IPAddress.TryParse(newIp, out _))
                    {
                        MessageBox.Show(this, "Die eingegebene IP ist ungültig.", "Fehler", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    var confirm = MessageBox.Show(this, $"Reservation ändern:\n\nScope: {scopeId}\nClientId: {clientId}\nVon: {oldIp}\nNach: {newIp}\n\nFortfahren?", "Bestätigen", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
                    if (confirm != DialogResult.Yes) return;

                    try
                    {
                        this.Enabled = false;

                        await DhcpManager.ChangeReservationIpAsync(
                            server,
                            scopeId,
                            oldIp,
                            newIp,
                            clientId,
                            newName,
                            newDescription,
                            s => GetCredentialsForServer(s)!
                        );

                        MessageBox.Show(this, "Reservation erfolgreich geändert.", "Erfolg", MessageBoxButtons.OK, MessageBoxIcon.Information);

                        // LOG: IP-Änderung protokollieren (zentral)
                        try
                        {
                            await LogGuiEventAsync(
                                "ChangeReservationIp",
                                scopeId,
                                newIp,
                                $"OldIp={oldIp};ClientId={clientId};OldName={hostName};NewName={newName};NewDesc={newDescription}");
                        }
                        catch { /* swallow logging errors */ }

                        await TryInvokeRefreshReservations(scopeId);
                        await TryInvokeRefreshLeases(scopeId);
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show(this, "Fehler beim Ändern der Reservation:\n" + ex.Message, "Fehler", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                    finally
                    {
                        this.Enabled = true;
                    }
                }
                else
                {
                    // Nur Description/Name aktualisieren -> UpdateReservationPropertiesAsync verwenden
                    try
                    {
                        this.Enabled = false;

                        await DhcpManager.UpdateReservationPropertiesAsync(
                            server,
                            scopeId,
                            oldIp,
                            clientId,
                            newName,
                            newDescription,
                            s => GetCredentialsForServer(s)!
                        );

                        MessageBox.Show(this, "Reservation-Eigenschaften erfolgreich aktualisiert.", "Erfolg", MessageBoxButtons.OK, MessageBoxIcon.Information);

                        // LOG: Properties-Update protokollieren (zentral)
                        try
                        {
                            await LogGuiEventAsync(
                                "UpdateReservationProperties",
                                scopeId,
                                oldIp,
                                $"ClientId={clientId};OldName={hostName};NewName={newName};OldDesc={prefetchedDescription};NewDesc={newDescription}");
                        }
                        catch { /* swallow */ }

                        await TryInvokeRefreshReservations(scopeId);
                        await TryInvokeRefreshLeases(scopeId);
                    }
                    catch (Exception ex)
                    {
                        MessageBox.Show(this, "Fehler beim Aktualisieren der Reservationseigenschaften:\n" + ex.Message, "Fehler", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                    finally
                    {
                        this.Enabled = true;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show(this, "Unerwarteter Fehler: " + ex.Message, "Fehler", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
    }
}
